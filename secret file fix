AWSTemplateFormatVersion: "2010-09-09"
Description: Secrets Manager and Systems Manager Parameter Store - Naming Convention

Parameters:
  Workstream:
    Type: String
    Description: Workstream identifier

  AppName:
    Type: String
    Description: Application name

  Environment:
    Type: String
    AllowedValues:
      - dev
      - qa
      - uat
      - prod
    Description: Environment name

  CostCenter:
    Type: String
    Description: Cost center for tagging

  Owner:
    Type: String
    Description: Owner for tagging

  ArtifactoryUsername:
    Type: String
    NoEcho: true
    Description: JFrog Artifactory username

  ArtifactoryPassword:
    Type: String
    NoEcho: true
    Description: JFrog Artifactory password

  ArtifactoryUrl:
    Type: String
    Description: JFrog Artifactory URL

  DockerHubToken:
    Type: String
    NoEcho: true
    Description: DockerHub access token

  DockerHubUsername:
    Type: String
    Description: DockerHub username

  OIDCClientId:
    Type: String
    Description: OIDC Client ID

  OIDCClientSecret:
    Type: String
    NoEcho: true
    Description: OIDC Client Secret

Resources:
  # =========================
  # SECRETS MANAGER
  # =========================
  ArtifactorySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "av-${Workstream}/cicd/${AppName}-${Environment}/streamlit-docker-artifactory"
      Description: JFrog Artifactory credentials for Streamlit Docker images
      SecretString: !Sub |
        {
          "username": "${ArtifactoryUsername}",
          "password": "${ArtifactoryPassword}",
          "url": "${ArtifactoryUrl}"
        }
      Tags:
        - Key: Name
          Value: !Sub "av-${Workstream}-${AppName}-secrets-${Environment}"
        - Key: Environment
          Value: !Ref Environment
        - Key: Workstream
          Value: !Ref Workstream
        - Key: AppName
          Value: !Ref AppName
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Owner
          Value: !Ref Owner

  OIDCCredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "av-${Workstream}/cicd/${AppName}-${Environment}/oidc"
      Description: OIDC credentials secret
      SecretString: !Sub |
        {
          "clientId": "${OIDCClientId}",
          "clientSecret": "${OIDCClientSecret}"
        }
      Tags:
        - Key: Name
          Value: !Sub "av-${Workstream}-${AppName}-oidc-${Environment}"
        - Key: Environment
          Value: !Ref Environment
        - Key: Workstream
          Value: !Ref Workstream
        - Key: AppName
          Value: !Ref AppName
        - Key: CostCenter
          Value: !Ref CostCenter
        - Key: Owner
          Value: !Ref Owner

  # =========================
  # SSM PARAMETER STORE
  # =========================
  ArtifactoryUsernameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/av-${Workstream}/cicd/${AppName}-${Environment}/artifactory/username"
      Type: String
      Value: !Ref ArtifactoryUsername
      Description: Parameter Store name for Artifactory username

  ArtifactoryPasswordParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/av-${Workstream}/cicd/${AppName}-${Environment}/artifactory/password"
      Type: SecureString
      Value: !Ref ArtifactoryPassword
      Description: Parameter Store name for Artifactory password

  ArtifactoryUrlParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/av-${Workstream}/cicd/${AppName}-${Environment}/artifactory/url"
      Type: String
      Value: !Ref ArtifactoryUrl
      Description: Parameter Store name for Artifactory URL

  DockerHubUsernameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/av-${Workstream}/cicd/${AppName}-${Environment}/dockerhub/username"
      Type: String
      Value: !Ref DockerHubUsername
      Description: Parameter Store name for DockerHub username

  DockerHubTokenParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/av-${Workstream}/cicd/${AppName}-${Environment}/dockerhub/token"
      Type: SecureString
      Value: !Ref DockerHubToken
      Description: Parameter Store name for DockerHub token

Outputs:
  ArtifactorySecretArn:
    Description: ARN of Artifactory credentials secret
    Value: !Ref ArtifactorySecret

  OIDCCredentialsSecretArn:
    Description: ARN of OIDC credentials secret
    Value: !Ref OIDCCredentialsSecret
